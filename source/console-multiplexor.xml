<?xml version="1.0" encoding="UTF-8"?>
<!-- **************************************************************************
.... For copyright and licensing terms, see the file named COPYING.
.... **************************************************************************
.-->
<?xml-stylesheet href="docbook-xml.css" type="text/css"?>

<refentry id="console-multiplexor">

<refmeta xmlns:xi="http://www.w3.org/2001/XInclude">
<refentrytitle>console-multiplexor</refentrytitle>
<manvolnum>1</manvolnum>
<refmiscinfo class="manual">user commands</refmiscinfo>
<refmiscinfo class="source">nosh</refmiscinfo>
<xi:include href="version.xml" />
</refmeta>

<refnamediv>
<refname>console-multiplexor</refname>
<refpurpose>realize many user-space virtual terminals on one</refpurpose>
</refnamediv>

<refsynopsisdiv>
<cmdsynopsis>
<command>console-multiplexor</command>
<arg choice='opt'>--display-only</arg>
<arg choice='req'><replaceable>muxname</replaceable></arg>
<arg choice='req' rep='repeat'><replaceable>vcname</replaceable></arg>
</cmdsynopsis>
</refsynopsisdiv>

<refsection><title>Description</title>

<para>
<command>console-multiplexor</command> multiplexes one or more (user-space) virtual terminals onto a single (user-space) virtual terminal, acting as a realizer for the former.
</para>

<para>
It opens the character/attribute buffer file(s) <filename><replaceable>vcname</replaceable>/display</filename> and the input FIFO(s) <filename><replaceable>vcname</replaceable>/input</filename>.
These are the "master side" interfaces of the user-space virtual terminal(s) being multiplexed, as detailed in <citerefentry><refentrytitle>console-terminal-emulator</refentrytitle><manvolnum>1</manvolnum></citerefentry>.
It does not attempt to create these if they do not exist.
</para>

<para>
It opens the character/attribute buffer file <filename><replaceable>muxname</replaceable>/display</filename> and the input FIFO <filename><replaceable>muxname</replaceable>/input</filename>.
These are the "master side" interfaces of the single user-space virtual terminal onto which the others are multiplexed.
It will create these if they do not exist.
They have their group IDs explicitly set to the effective GID of the multiplexor process.
</para>

<para>
It then enters a loop where it simultaneously:
</para>

<itemizedlist>

<listitem>
<para>
(unless the <arg choice='plain'>--display-only</arg> option is used) writes all data received from the mux input FIFO to the input FIFO for the foreground virtual terminal; and
</para>
</listitem>

<listitem>
<para>
renders the contents of the character/attribute buffer file for the foreground virtual terminal on the mux virtual terminal's display buffer.
</para>
</listitem>

</itemizedlist>

<para>
One virtual terminal is in the foreground.
This is the virtual terminal that is currently rendered onto the mux display buffer and to which input events are sent.
It is changed in response to special session switch input events, generated by whatever realizer is attached to the mux virtual terminal; and key events for the Next Task, Previous Task, and Task Selection Consumer keypad keys.
These events are filtered from the input stream and not passed along to the multiplexed virtual terminals.
(The multiplexor also consumes other Consumer keys such as Terminal Lock, Log In, Log Out, Task Manager, and Halt Task.  These are reserved for future use.)
<para>

</para>
The session switch event extension to the <citerefentry><refentrytitle>console-terminal-emulator</refentrytitle><manvolnum>1</manvolnum></citerefentry> input protocol is
</para>
<variablelist>
<varlistentry>
<term><code>0x0Annnnmm</code></term>
<listitem><para>
A session switch request.
The session number is <code>nnnn</code> and <code>mm</code> is a set of bitflags indicating the current state of modifier keys.
Sessions are numbered from 0, as per the FreeBSD and NetBSD console conventions.
</para></listitem>
</varlistentry>
</variablelist>

<para>
Because of the modular nature of user space virtual terminals, there is no notion of an "active" virtual terminal that is visible to the programs that are running on the virtual terminals.
Multiple multiplexers and realizers may be attached to the "master side" of any given virtual terminal; or indeed none may be attached at all.
Session switching is commanded by realizers, exacted by multiplexors; and the terminal emulators have no hand in it.
</para>

</refsection>

<refsection><title>Security</title>

<para>
<command>console-multiplexor</command> requires no superuser privileges and is designed to be run entirely under the aegis of a dedicated unprivileged user account.
It only requires write and search access to <filename><replaceable>muxname</replaceable>/</filename> and need not have owner access to it.
</para>

<para>
Usually <filename><replaceable>muxname</replaceable>/</filename> will be set-group-ID to a group different to the effective group ID of the multiplexor process.
Changing the groups of <filename><replaceable>muxname</replaceable>/input</filename>, <filename><replaceable>muxname</replaceable>/display</filename> to the effective group ID of the emulator process thus distinguishes group access to those files, allowing one to add ordinary users to that group in order to give them direct realizer access to the emulated terminal.
</para>

</refsection>

<refsection><title>Author</title>
<para><author><personname><firstname>Jonathan</firstname> <surname>de Boyne Pollard</surname></personname></author></para>
</refsection>

</refentry>
